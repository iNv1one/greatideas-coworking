<!-- –ò–≥—Ä–æ–≤–æ–π —Ç–∞–π–º–µ—Ä (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç) -->
<div class="game-timer">
    <div class="timer-content">
        <div class="time-display">
            <span class="time-value" id="gameTime">08:00</span>
        </div>
        <div class="day-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="timeProgress" style="width: 33%"></div>
                <div class="progress-marker"></div>
            </div>
        </div>
        <div class="day-counter">
            <span class="day-label">DAY:</span>
            <span class="day-value" id="gameDay">1</span>
        </div>
        <div class="money-counter">
            <span class="money-label">üí∞</span>
            <span class="money-value" id="gameMoney">500</span>
        </div>
    </div>
</div>

<style>
.game-timer {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 25px;
    padding: 15px 30px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.timer-content {
    display: flex;
    align-items: center;
    gap: 20px;
    color: #fff;
}

.time-display {
    font-family: 'Courier New', monospace;
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffa500;
    text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.day-progress {
    position: relative;
    width: 200px;
    height: 8px;
}

.progress-bar {
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffa500, #ff6b35);
    border-radius: 4px;
    transition: width 1s ease;
    box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.progress-marker {
    position: absolute;
    top: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 12px;
    background: #fff;
    border-radius: 2px;
    opacity: 0.7;
}

.day-counter {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: bold;
}

.day-label {
    color: #ccc;
}

.day-value {
    color: #ffa500;
    text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.money-counter {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: bold;
}

.money-label {
    font-size: 1.2rem;
}

.money-value {
    color: #00ff00;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 768px) {
    .game-timer {
        top: 10px;
        left: 10px;
        right: 10px;
        transform: none;
        padding: 10px 15px;
    }
    
    .timer-content {
        gap: 15px;
        font-size: 0.9rem;
    }
    
    .time-display {
        font-size: 1.2rem;
    }
    
    .day-progress {
        width: 120px;
    }
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function updateGameTimer(gameTime, gameDay) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏–Ω—É—Ç—ã –≤ —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
    const hours = Math.floor(gameTime / 60);
    const minutes = gameTime % 60;
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('gameTime').textContent = timeString;
    document.getElementById('gameDay').textContent = gameDay;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–¥–µ–Ω—å = 24 —á–∞—Å–∞ = 1440 –º–∏–Ω—É—Ç)
    const progressPercent = (gameTime / 1440) * 100;
    document.getElementById('timeProgress').style.width = progressPercent + '%';
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
let currentGameTime = 480; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let currentGameDay = 1;
let gamePaused = false;
let currentMoney = 500;

function startGameTimer() {
    setInterval(() => {
        if (gamePaused) return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ
        
        currentGameTime += 48; // 48 –º–∏–Ω—É—Ç –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É = 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –¥–µ–Ω—å (1440/30 = 48)
        
        // –ï—Å–ª–∏ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å (1440 –º–∏–Ω—É—Ç = 24 —á–∞—Å–∞)
        if (currentGameTime >= 1440) {
            currentGameTime = 0;
            currentGameDay += 1;
            
            // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ç—Ä–∞—Ç–∏–º 50$
            currentMoney -= 50;
            updateMoneyDisplay();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è
            checkForEvents();
        }
        
        updateGameTimer(currentGameTime, currentGameDay);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        if (Math.floor(currentGameTime / 48) % 10 === 0) {
            syncTimeWithServer();
        }
    }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ–Ω–µ–≥
function updateMoneyDisplay() {
    document.getElementById('gameMoney').textContent = currentMoney;
    
    // –ï—Å–ª–∏ –¥–µ–Ω–µ–≥ –º–∞–ª–æ, –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π
    const moneyElement = document.getElementById('gameMoney');
    if (currentMoney < 100) {
        moneyElement.style.color = '#ff0000';
        moneyElement.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
    } else {
        moneyElement.style.color = '#00ff00';
        moneyElement.style.textShadow = '0 0 10px rgba(0, 255, 0, 0.5)';
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π
function checkForEvents() {
    // –ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ 4-6 –¥–µ–Ω—å
    if (currentGameDay >= 4 && currentGameDay <= 6 && !hasEventOccurred('startup_idea')) {
        triggerEvent('startup_idea');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–∏–∑–æ—à–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ
function hasEventOccurred(eventId) {
    return localStorage.getItem('event_' + eventId) === 'true';
}

// –ó–∞–ø—É—Å–∫ —Å–æ–±—ã—Ç–∏—è
function triggerEvent(eventId) {
    gamePaused = true;
    localStorage.setItem('event_' + eventId, 'true');
    
    if (eventId === 'startup_idea') {
        showStartupIdeaEvent();
    }
}

// –ü–æ–∫–∞–∑ —Å–æ–±—ã—Ç–∏—è "–ò–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞"
function showStartupIdeaEvent() {
    const modal = document.getElementById('eventModal');
    if (!modal) {
        createEventModal();
    }
    
    const title = document.getElementById('eventTitle');
    const description = document.getElementById('eventDescription');
    const choices = document.getElementById('eventChoices');
    
    title.textContent = '–ò–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞';
    description.textContent = '–£ –≤–∞—Å –µ—Å—Ç—å –∏–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ–Ω–∏—Ç –º–∏—Ä, –Ω–æ —á—Ç–æ —Å –Ω–µ–π –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?';
    
    choices.innerHTML = `
        <button class="btn btn-primary event-choice" onclick="makeChoice('friends')">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏, –ø–æ–ª—É—á–∏—Ç—å –∏—Ö –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
        </button>
        <button class="btn btn-primary event-choice" onclick="makeChoice('presentation')">
            –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –ø–∏—Ç—á–∏–Ω–≥–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
        </button>
        <button class="btn btn-primary event-choice" onclick="makeChoice('prototype')">
            –ó–∞–Ω—è—Ç—å—Å—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–æ–º –∏–¥–µ–∏, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
        </button>
    `;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
function createEventModal() {
    const modalHTML = `
        <div class="modal fade" id="eventModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventTitle">–°–æ–±—ã—Ç–∏–µ</h5>
                    </div>
                    <div class="modal-body">
                        <p id="eventDescription">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</p>
                        <div id="eventChoices" class="d-grid gap-2">
                            <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// –í—ã–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è
function makeChoice(choice) {
    // –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫ (1-6)
    const diceRoll = Math.floor(Math.random() * 6) + 1;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
    localStorage.setItem('last_choice', choice);
    localStorage.setItem('last_dice_roll', diceRoll);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    showChoiceResult(choice, diceRoll);
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–±–æ—Ä–∞
function showChoiceResult(choice, diceRoll) {
    const description = document.getElementById('eventDescription');
    const choices = document.getElementById('eventChoices');
    
    let resultText = '';
    
    if (choice === 'friends') {
        if (diceRoll >= 5) {
            resultText = '–î—Ä—É–∑—å—è –±—ã–ª–∏ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ –æ—Ç –≤–∞—à–µ–π –∏–¥–µ–∏! –û–Ω–∏ –¥–∞–ª–∏ –º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –∏ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å. +50$ –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏!';
            currentMoney += 50;
        } else if (diceRoll >= 3) {
            resultText = '–î—Ä—É–∑—å—è –æ—Ç–Ω–µ—Å–ª–∏—Å—å –∫ –∏–¥–µ–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ. –ü–æ–ª—É—á–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–º–µ—á–∞–Ω–∏–π, –Ω–æ –Ω–∏—á–µ–≥–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ.';
        } else {
            resultText = '–î—Ä—É–∑—å—è –æ—Ç–Ω–µ—Å–ª–∏—Å—å –∫ –∏–¥–µ–µ —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–∏—à–ª–æ—Å—å –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. -20$ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏.';
            currentMoney -= 20;
        }
    } else if (choice === 'presentation') {
        resultText = '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞! –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –≤—Ä–µ–º—è, –Ω–æ —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.';
    } else if (choice === 'prototype') {
        resultText = '–ü—Ä–æ—Ç–æ—Ç–∏–ø –≥–æ—Ç–æ–≤! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –∏ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º.';
    }
    
    description.textContent = resultText;
    choices.innerHTML = `
        <button class="btn btn-success" onclick="continueGame()">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
        </button>
    `;
    
    updateMoneyDisplay();
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    syncChoiceWithServer(choice, diceRoll);
}

// –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
function continueGame() {
    gamePaused = false;
    const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
    modal.hide();
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function syncChoiceWithServer(choice, diceRoll) {
    fetch('/game/api/choice/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            choice: choice,
            dice_roll: diceRoll,
            money: currentMoney
        })
    }).catch(err => console.log('Choice sync error:', err));
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function syncTimeWithServer() {
    if (typeof fetch !== 'undefined') {
        fetch('/game/api/sync-time/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                game_time: currentGameTime,
                day: currentGameDay
            })
        }).catch(err => console.log('Sync error:', err));
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Django (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
    if (typeof gameTimerData !== 'undefined') {
        currentGameTime = gameTimerData.gameTime || 480;
        currentGameDay = gameTimerData.gameDay || 1;
        gamePaused = gameTimerData.gamePaused || false;
        currentMoney = gameTimerData.currentMoney || 500;
    }
    
    updateGameTimer(currentGameTime, currentGameDay);
    updateMoneyDisplay();
    startGameTimer();
});
</script>