<!-- –ò–≥—Ä–æ–≤–æ–π —Ç–∞–π–º–µ—Ä (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç) -->
<div class="game-timer">
    <div class="timer-content">
        <div class="time-display">
            <span class="time-value" id="gameTime">08:00</span>
        </div>
        <div class="event-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="eventProgress" style="width: 0%"></div>
                <div class="progress-marker"></div>
            </div>
            <div class="progress-label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è</div>
        </div>
        <div class="day-counter">
            <span class="day-label">–î–µ–Ω—å:</span>
            <span class="day-value" id="gameDay">1</span>
        </div>
        <div class="money-counter">
            <span class="money-label">üí∞</span>
            <span class="money-value" id="gameMoney">500</span>
        </div>
    </div>
</div>

<style>
.game-timer {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 25px;
    padding: 15px 30px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.timer-content {
    display: flex;
    align-items: center;
    gap: 20px;
    color: #fff;
}

.time-display {
    font-family: 'Courier New', monospace;
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffa500;
    text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.event-progress {
    position: relative;
    width: 200px;
    height: 8px;
}

.progress-label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
    margin-top: 2px;
}

.progress-bar {
    width: 100%;
    height: 100%;
    background: transparent;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffa500, #ff6b35);
    border-radius: 4px;
    transition: width 1s ease;
    box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.progress-marker {
    position: absolute;
    top: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 12px;
    background: #fff;
    border-radius: 2px;
    opacity: 0.7;
}

.day-counter {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: bold;
}

.day-label {
    color: #ccc;
}

.day-value {
    color: #ffa500;
    text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
}

.money-counter {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: bold;
}

.money-label {
    font-size: 1.2rem;
}

.money-value {
    color: #00ff00;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 768px) {
    .game-timer {
        top: 10px;
        left: 10px;
        right: 10px;
        transform: none;
        padding: 10px 15px;
    }
    
    .timer-content {
        gap: 15px;
        font-size: 0.9rem;
    }
    
    .time-display {
        font-size: 1.2rem;
    }
    
    .event-progress {
        width: 120px;
    }
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function updateGameTimer(gameTime, gameDay) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏–Ω—É—Ç—ã –≤ —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
    const hours = Math.floor(gameTime / 60);
    const minutes = gameTime % 60;
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('gameTime').textContent = timeString;
    document.getElementById('gameDay').textContent = gameDay;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–π–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    updateEventProgress();
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
let currentGameTime = 480; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let currentGameDay = 1;
let gamePaused = false;
let currentMoney = 500;
let nextEventTime = 0; // –í—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
let eventTimeLeft = 0; // –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–æ —Å–æ–±—ã—Ç–∏—è

function startGameTimer() {
    setInterval(() => {
        if (gamePaused) return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ
        
        currentGameTime += 24; // 24 –º–∏–Ω—É—Ç—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É = 1 –º–∏–Ω—É—Ç–∞ –Ω–∞ –¥–µ–Ω—å (1440/60 = 24)
        
        // –ï—Å–ª–∏ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å (1440 –º–∏–Ω—É—Ç = 24 —á–∞—Å–∞)
        if (currentGameTime >= 1440) {
            currentGameTime = 0;
            currentGameDay += 1;
            
            // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ç—Ä–∞—Ç–∏–º 50$
            currentMoney -= 50;
            updateMoneyDisplay();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è
            checkForEvents();
        }
        
        updateGameTimer(currentGameTime, currentGameDay);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        if (Math.floor(currentGameTime / 24) % 10 === 0) {
            syncTimeWithServer();
        }
    }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ–Ω–µ–≥
function updateMoneyDisplay() {
    document.getElementById('gameMoney').textContent = currentMoney;
    
    // –ï—Å–ª–∏ –¥–µ–Ω–µ–≥ –º–∞–ª–æ, –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π
    const moneyElement = document.getElementById('gameMoney');
    if (currentMoney < 100) {
        moneyElement.style.color = '#ff0000';
        moneyElement.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
    } else {
        moneyElement.style.color = '#00ff00';
        moneyElement.style.textShadow = '0 0 10px rgba(0, 255, 0, 0.5)';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateEventProgress() {
    if (eventTimeLeft <= 0) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è (20-40 —Å–µ–∫—É–Ω–¥)
        eventTimeLeft = 20 + Math.random() * 20;
        nextEventTime = eventTimeLeft;
    }
    
    eventTimeLeft--;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–æ—Ç 0% –¥–æ 100%)
    const progressPercent = ((nextEventTime - eventTimeLeft) / nextEventTime) * 100;
    document.getElementById('eventProgress').style.width = progressPercent + '%';
    
    // –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
    if (eventTimeLeft <= 0) {
        console.log('Event timer reached 0, triggering random event...');
        triggerRandomEvent();
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π
function checkForEvents() {
    // –ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ 4-6 –¥–µ–Ω—å
    if (currentGameDay >= 4 && currentGameDay <= 6) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if (window.eventConfigs && Object.keys(window.eventConfigs).length > 0) {
            const firstEventKey = Object.keys(window.eventConfigs)[0];
            if (!hasEventOccurred(firstEventKey)) {
                triggerEvent(firstEventKey);
            }
        } else if (!hasEventOccurred('startup_idea')) {
            triggerEvent('startup_idea');
        }
    }
}

// –ó–∞–ø—É—Å–∫ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function triggerRandomEvent() {
    console.log('=== triggerRandomEvent called ===');
    console.log('window.eventConfigs:', window.eventConfigs);
    console.log('eventConfigs keys:', window.eventConfigs ? Object.keys(window.eventConfigs) : 'undefined');
    
    // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏—è –∏–∑ API –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if (window.eventConfigs && Object.keys(window.eventConfigs).length > 0) {
        const eventKeys = Object.keys(window.eventConfigs);
        console.log('Available event keys:', eventKeys);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –ë–î
        await loadCompletedEvents();
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏
        const availableEvents = eventKeys.filter(key => {
            const occurred = hasEventOccurred(key);
            console.log(`Event ${key} occurred:`, occurred);
            return !occurred;
        });
        
        console.log('Available events (not occurred):', availableEvents);
        
        if (availableEvents.length > 0) {
            const randomEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
            console.log('Selected random event:', randomEvent);
            triggerEvent(randomEvent);
            return;
        } else {
            console.log('All events have already occurred!');
        }
    } else {
        console.log('No API events found, using fallback');
    }
    
    // Fallback: —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞
    const events = ['market_research', 'investor_meeting', 'team_building', 'product_launch'];
    const randomEvent = events[Math.floor(Math.random() * events.length)];
    console.log('Fallback event selected:', randomEvent);
    triggerEvent(randomEvent);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–∏–∑–æ—à–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ (—Ç–µ–ø–µ—Ä—å –∏–∑ –ë–î)
function hasEventOccurred(eventId) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∫—ç—à–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    if (window.completedEvents) {
        return window.completedEvents.some(event => event.event_key === eventId);
    }
    return false;
}

// –ó–∞–ø—É—Å–∫ —Å–æ–±—ã—Ç–∏—è
function triggerEvent(eventId) {
    console.log('=== triggerEvent called ===');
    console.log('Event ID:', eventId);
    console.log('window.eventConfigs:', window.eventConfigs);
    console.log('Event exists in API:', window.eventConfigs && window.eventConfigs[eventId]);
    
    // –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–π
    console.log('Available functions:');
    console.log('- showEvent (old):', typeof showEvent);
    console.log('- showGameEvent (new):', typeof showGameEvent);
    console.log('- createEventModal:', typeof createEventModal);
    
    gamePaused = true;
    stopSkillOrbSystem();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –ë–î –≤–º–µ—Å—Ç–æ localStorage
    markEventAsCompleted(eventId);
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ API
    if (window.eventConfigs && window.eventConfigs[eventId]) {
        console.log('Showing API event:', eventId);
        console.log('showGameEvent function exists:', typeof showGameEvent);
        console.log('showGameEvent function:', showGameEvent);
        try {
            showGameEvent(eventId);
        } catch (error) {
            console.error('Error in showGameEvent:', error);
            console.error('Error stack:', error.stack);
        }
        return;
    }
    
    console.log('Using fallback events for:', eventId);
    
    // Fallback: —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è
    if (eventId === 'startup_idea') {
        showStartupIdeaEvent();
    } else if (eventId === 'market_research') {
        showMarketResearchEvent();
    } else if (eventId === 'investor_meeting') {
        showInvestorMeetingEvent();
    } else if (eventId === 'team_building') {
        showTeamBuildingEvent();
    } else if (eventId === 'product_launch') {
        showProductLaunchEvent();
    }
}

// –ü–æ–∫–∞–∑ —Å–æ–±—ã—Ç–∏—è "–ò–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞"
function showStartupIdeaEvent() {
    const modal = document.getElementById('eventModal');
    if (!modal) {
        createEventModal();
    }
    
    const title = document.getElementById('eventTitle');
    const description = document.getElementById('eventDescription');
    const choices = document.getElementById('eventChoices');
    
    title.textContent = '–ò–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞';
    description.textContent = '–£ –≤–∞—Å –µ—Å—Ç—å –∏–¥–µ—è —Å—Ç–∞—Ä—Ç–∞–ø–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ–Ω–∏—Ç –º–∏—Ä, –Ω–æ —á—Ç–æ —Å –Ω–µ–π –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?';
    
    choices.innerHTML = `
        <button class="btn btn-primary event-choice" onclick="makeChoice('friends')">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏, –ø–æ–ª—É—á–∏—Ç—å –∏—Ö –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
        </button>
        <button class="btn btn-primary event-choice" onclick="makeChoice('presentation')">
            –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –ø–∏—Ç—á–∏–Ω–≥–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
        </button>
        <button class="btn btn-primary event-choice" onclick="makeChoice('prototype')">
            –ó–∞–Ω—è—Ç—å—Å—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–æ–º –∏–¥–µ–∏, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
        </button>
    `;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
function createEventModal() {
    console.log('Creating modal HTML...');
    const modalHTML = `
        <div class="modal fade" id="eventModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventTitle">–°–æ–±—ã—Ç–∏–µ</h5>
                    </div>
                    <div class="modal-body">
                        <p id="eventDescription">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</p>
                        <div id="eventChoices" class="d-grid gap-2">
                            <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show" id="eventModalBackdrop"></div>
    `;
    
    console.log('Inserting modal HTML into body...');
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    console.log('Modal HTML inserted');
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
function showGameEvent(eventKey) {
    console.log('=== showGameEvent called ===');
    console.log('Event key:', eventKey);
    console.log('eventConfigs:', eventConfigs);
    
    const config = eventConfigs[eventKey];
    if (!config) {
        console.error('Event config not found:', eventKey);
        return;
    }
    
    console.log('Event config found:', config);
    
    let modal = document.getElementById('eventModal');
    if (modal) {
        console.log('Removing existing modal');
        modal.remove();
    }
    
    console.log('Creating event modal...');
    createEventModal();
    modal = document.getElementById('eventModal');
    console.log('Modal created:', modal);
    
    const title = document.getElementById('eventTitle');
    const description = document.getElementById('eventDescription');
    const choices = document.getElementById('eventChoices');
    
    title.textContent = config.title;
    description.textContent = config.description;
    
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö
    let choicesHTML = '';
    config.choices.forEach(choice => {
        const buttonClass = getButtonClass(choice);
        const timeText = choice.timeCost === 1 ? '1 –¥–µ–Ω—å' : `${choice.timeCost} –¥–Ω—è`;
        const moneyText = choice.moneyCost === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : `$${choice.moneyCost}`;
        
        choicesHTML += `
            <button class="btn ${buttonClass} event-choice mb-2" onclick="makeChoice('${choice.id}', '${eventKey}')">
                <div class="choice-title">${choice.text}</div>
                <div class="choice-description">${choice.description}</div>
                <div class="choice-costs">
                    <span class="time-cost">‚è±Ô∏è ${timeText}</span>
                    <span class="money-cost">üí∞ ${moneyText}</span>
                </div>
            </button>
        `;
    });
    
    choices.innerHTML = choicesHTML;
    
    console.log('Setting modal visibility...');
    modal.style.display = 'block';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    console.log('Modal should be visible now. Modal element:', modal);
    console.log('Modal display style:', modal.style.display);
    console.log('Modal classes:', modal.className);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –∫–Ω–æ–ø–∫–∏
function getButtonClass(choice) {
    // –ï—Å–ª–∏ –≤ –≤—ã–±–æ—Ä–µ –µ—Å—Ç—å buttonStyle, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (choice.buttonStyle) {
        return choice.buttonStyle;
    }
    
    // Fallback –∫ —Å—Ç–∞—Ä—ã–º —Å—Ç–∏–ª—è–º
    const buttonClasses = {
        'survey': 'btn-success',
        'competitors': 'btn-info', 
        'focus_group': 'btn-warning',
        'passionate': 'btn-primary',
        'numbers': 'btn-secondary',
        'demo': 'btn-success',
        'developer': 'btn-info',
        'marketer': 'btn-warning',
        'cofounder': 'btn-danger',
        'beta': 'btn-success',
        'full_launch': 'btn-primary',
        'soft_launch': 'btn-secondary'
    };
    return buttonClasses[choice.id] || 'btn-primary';
}

// –°–æ–±—ã—Ç–∏–µ "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞"
function showMarketResearchEvent() {
    showGameEvent('market_research');
}

// –°–æ–±—ã—Ç–∏–µ "–í—Å—Ç—Ä–µ—á–∞ —Å –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–º"
function showInvestorMeetingEvent() {
    showGameEvent('investor_meeting');
}

// –°–æ–±—ã—Ç–∏–µ "–ù–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã"
function showTeamBuildingEvent() {
    showGameEvent('team_building');
}

// –°–æ–±—ã—Ç–∏–µ "–ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞"
function showProductLaunchEvent() {
    showGameEvent('product_launch');
}

// –í—ã–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è
function makeChoice(choiceId, eventKey) {
    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏—è –∏ –≤—ã–±–æ—Ä–∞
    const eventConfig = eventConfigs[eventKey];
    if (!eventConfig) {
        console.error('Event config not found:', eventKey);
        return;
    }
    
    const choice = eventConfig.choices.find(c => c.id === choiceId);
    if (!choice) {
        console.error('Choice not found:', choiceId, 'in event:', eventKey);
        return;
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞—Ç—Ä–∞—Ç—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã
    applyChoiceEffects(choice);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –¥–ª—è –æ—Ä–±–æ–≤
    updateAvailableSkills(choice);
    
    // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç
    scheduleNextEvent(choice.timeCost);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    showChoiceResult(choice, eventKey);
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
function applyChoiceEffects(choice) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –¥–µ–Ω–µ–≥
    if (choice.moneyCost > currentMoney) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è!');
        return false;
    }
    
    // –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏
    currentMoney -= choice.moneyCost;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
    if (choice.effects) {
        Object.keys(choice.effects).forEach(effect => {
            const value = choice.effects[effect];
            
            switch(effect) {
                case 'money':
                    currentMoney += value;
                    break;
                case 'reputation':
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø—É—Ç–∞—Ü–∏—é (–ø–æ–∫–∞ –≤ JS –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
                    break;
                case 'employees':
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    break;
                case 'customers':
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
                    break;
                case 'prototype_skill':
                    currentSkills.prototype += value;
                    break;
                case 'presentation_skill':
                    currentSkills.presentation += value;
                    break;
                case 'pitching_skill':
                    currentSkills.pitching += value;
                    break;
                case 'team_skill':
                    currentSkills.team += value;
                    break;
            }
        });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateMoneyDisplay();
    updateSkillsUI();
    
    return true;
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–±–æ—Ä–∞
function showChoiceResult(choice, eventKey) {
    const description = document.getElementById('eventDescription');
    const choices = document.getElementById('eventChoices');
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    let resultText = `–í—ã–±–æ—Ä "${choice.text}" –≤—ã–ø–æ–ª–Ω–µ–Ω!`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö
    const timeText = choice.timeCost === 1 ? '1 –¥–µ–Ω—å' : `${choice.timeCost} –¥–Ω—è`;
    if (choice.moneyCost > 0) {
        resultText += ` –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${timeText} –≤—Ä–µ–º–µ–Ω–∏ –∏ $${choice.moneyCost}.`;
    } else {
        resultText += ` –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${timeText} –≤—Ä–µ–º–µ–Ω–∏.`;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö
    if (choice.effects) {
        const effects = [];
        Object.keys(choice.effects).forEach(effect => {
            const value = choice.effects[effect];
            switch(effect) {
                case 'money':
                    effects.push(`+$${value}`);
                    break;
                case 'reputation':
                    effects.push(`+${value} —Ä–µ–ø—É—Ç–∞—Ü–∏—è`);
                    break;
                case 'employees':
                    effects.push(`+${value} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫${value > 1 ? '–∞' : ''}`);
                    break;
                case 'customers':
                    effects.push(`+${value} –∫–ª–∏–µ–Ω—Ç${value > 1 ? '–∞' : ''}`);
                    break;
                case 'prototype_skill':
                    effects.push(`+${value} –Ω–∞–≤—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏`);
                    break;
                case 'presentation_skill':
                    effects.push(`+${value} –Ω–∞–≤—ã–∫ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π`);
                    break;
                case 'pitching_skill':
                    effects.push(`+${value} –Ω–∞–≤—ã–∫ –ø–∏—Ç—á–∏–Ω–≥–∞`);
                    break;
                case 'team_skill':
                    effects.push(`+${value} –Ω–∞–≤—ã–∫ —Ç–∏–º–±–∏–ª–¥–∏–Ω–≥–∞`);
                    break;
            }
        });
        
        if (effects.length > 0) {
            resultText += ` –ü–æ–ª—É—á–µ–Ω–æ: ${effects.join(', ')}.`;
        }
    }
    
    resultText += ` –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —á–µ—Ä–µ–∑ ${choice.timeCost === 1 ? '1 –¥–µ–Ω—å' : `${choice.timeCost} –¥–Ω—è`}.`;
    
    description.textContent = resultText;
    choices.innerHTML = `
        <button class="btn btn-success" onclick="continueGame()">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
        </button>
    `;
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    syncChoiceWithServer(choice.id, eventKey);
}

// –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
function scheduleNextEvent(timeCostDays) {
    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –¥–Ω–∏ –≤ –º–∏–Ω—É—Ç—ã –∏–≥—Ä–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (1 –¥–µ–Ω—å = 1 –º–∏–Ω—É—Ç–∞)
    const delayMinutes = timeCostDays * 1;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä —Å–æ–±—ã—Ç–∏–π
    eventTimeLeft = delayMinutes * 60; // –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ–∫—É–Ω–¥—ã
    nextEventTime = eventTimeLeft;
    
    console.log(`–°–ª–µ–¥—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ ${timeCostDays} –¥–Ω—è (${delayMinutes} –º–∏–Ω—É—Ç –∏–≥—Ä–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)`);
}

// –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
function continueGame() {
    gamePaused = false;
    resumeSkillOrbSystem();
    const modal = document.getElementById('eventModal');
    const backdrop = document.getElementById('eventModalBackdrop');
    
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.remove();
    }
    
    if (backdrop) {
        backdrop.remove();
    }
    
    document.body.classList.remove('modal-open');
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function syncChoiceWithServer(choice, diceRoll) {
    fetch('/game/api/choice/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            choice: choice,
            dice_roll: diceRoll,
            money: currentMoney
        })
    }).catch(err => console.log('Choice sync error:', err));
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function syncTimeWithServer() {
    if (typeof fetch !== 'undefined') {
        fetch('/game/api/sync-time/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                game_time: currentGameTime,
                day: currentGameDay
            })
        }).catch(err => console.log('Sync error:', err));
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', async function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    await loadEventConfigs();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –ë–î
    await loadCompletedEvents();
    
    // –°–æ–∑–¥–∞–µ–º UI –Ω–∞–≤—ã–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    createSkillsUI();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Django (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
    if (typeof gameTimerData !== 'undefined') {
        currentGameTime = gameTimerData.gameTime || 480;
        currentGameDay = gameTimerData.gameDay || 1;
        gamePaused = gameTimerData.gamePaused || false;
        currentMoney = gameTimerData.currentMoney || 500;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏ –∏–∑ —Å–µ—Å—Å–∏–∏
        if (gameTimerData.skills && currentGameDay > 1) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –Ω–æ–≤–∞—è
            currentSkills.prototype = gameTimerData.skills.prototype || 0;
            currentSkills.presentation = gameTimerData.skills.presentation || 0;
            currentSkills.pitching = gameTimerData.skills.pitching || 0;
            currentSkills.team = gameTimerData.skills.team || 0;
        } else {
            // –î–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã (–¥–µ–Ω—å 1) –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–≤—ã–∫–∏ –≤ 0
            currentSkills.prototype = 0;
            currentSkills.presentation = 0;
            currentSkills.pitching = 0;
            currentSkills.team = 0;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –Ω–∞–≤—ã–∫–æ–≤
        updateSkillsUI();
    }
    
    updateGameTimer(currentGameTime, currentGameDay);
    updateMoneyDisplay();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–π–Ω—ã–π —Ç–∞–π–º–µ—Ä
    eventTimeLeft = 1; // –ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    nextEventTime = eventTimeLeft;
    
    startGameTimer();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É –∫—Ä—É–∂–æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
    startSkillOrbSystem();
});

// –°–∏—Å—Ç–µ–º–∞ –∫—Ä—É–∂–æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
let skillOrbInterval = null;
let activeOrbs = [];
let availableSkills = []; // –ù–∞–≤—ã–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –æ—Ä–±–æ–≤ (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±–æ—Ä–∞)

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–≤—ã–∫–∏ —Å –∏—Ö —Ü–≤–µ—Ç–∞–º–∏ –∏ –∏–∫–æ–Ω–∫–∞–º–∏ (fallback –¥–ª—è —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã)
const skillTypes = [
    { key: 'prototype', type: 'prototype', sessionField: 'prototype', icon: '‚öôÔ∏è', name: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞' },
    { key: 'presentation', type: 'presentation', sessionField: 'presentation', icon: 'üìä', name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏' },
    { key: 'pitching', type: 'pitching', sessionField: 'pitching', icon: 'üéØ', name: '–ü–∏—Ç—á–∏–Ω–≥' },
    { key: 'team', type: 'team', sessionField: 'team', icon: 'üë•', name: '–¢–∏–º–±–∏–ª–¥–∏–Ω–≥' }
];

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (–±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ API)
let eventConfigs = {};
// availableSkills —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function loadEventConfigs() {
    try {
        const response = await fetch('/game/api/events/');
        if (response.ok) {
            const apiData = await response.json();
            
            // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç API: { events: {...}, availableSkills: [...] }
            if (apiData.events && apiData.availableSkills) {
                eventConfigs = apiData.events;
                window.eventConfigs = apiData.events; // –ì–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                availableSkills = apiData.availableSkills;
                window.availableSkills = apiData.availableSkills; // –ì–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
                console.log('–°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', Object.keys(eventConfigs));
                console.log('–ù–∞–≤—ã–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', availableSkills.length);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–≤—ã–∫–æ–≤
                window.dispatchEvent(new CustomEvent('skillsLoaded', { detail: apiData.availableSkills }));
            } else {
                // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç API - —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è
                eventConfigs = apiData;
                window.eventConfigs = apiData; // –ì–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                availableSkills = [];
                window.availableSkills = [];
                console.log('–°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç):', Object.keys(eventConfigs));
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–≤—ã–∫–æ–≤ (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
                window.dispatchEvent(new CustomEvent('skillsLoaded', { detail: [] }));
            }
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', response.status, response.statusText);
            // Fallback –∫ —Å—Ç–∞—Ä—ã–º —Å–æ–±—ã—Ç–∏—è–º –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            loadFallbackEvents();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–±—ã—Ç–∏–π:', error);
        loadFallbackEvents();
    }
}

// –ó–∞–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
function loadFallbackEvents() {
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º fallback —Å–æ–±—ã—Ç–∏—è –∏ –Ω–∞–≤—ã–∫–∏...');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º fallback –Ω–∞–≤—ã–∫–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
    availableSkills = [...skillTypes];
    window.availableSkills = [...skillTypes];
    
    // –û—á–∏—â–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è fallback (–ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç)
    window.eventConfigs = {};
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–≤—ã–∫–æ–≤ (fallback –Ω–∞–≤—ã–∫–∏)
    window.dispatchEvent(new CustomEvent('skillsLoaded', { detail: [...skillTypes] }));
    
    eventConfigs = {
        market_research: {
            title: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞',
            description: '–£ –≤–∞—Å –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞. –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –≤—ã–±–µ—Ä–µ—Ç–µ?',
            choices: [
                {
                    id: 'survey',
                    text: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –æ–Ω–ª–∞–π–Ω-–æ–ø—Ä–æ—Å',
                    description: '–ë—ã—Å—Ç—Ä–æ –∏ –Ω–µ–¥–æ—Ä–æ–≥–æ',
                    timeCost: 1,
                    moneyCost: 50,
                    effects: { reputation: 2, customers: 5 }
                }
            ]
        }
    };
}

// –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
let currentSkills = {
    prototype: 0,
    presentation: 0,
    pitching: 0,
    team: 0
};

// –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –∫—Ä—É–∂–æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
function startSkillOrbSystem() {
    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–∂–æ—á–∫–∏ –∫–∞–∂–¥—ã–µ 2-4 —Å–µ–∫—É–Ω–¥—ã
    skillOrbInterval = setInterval(() => {
        if (!gamePaused && Math.random() < 0.7) { // 70% —à–∞–Ω—Å —Å–æ–∑–¥–∞–Ω–∏—è
            createSkillOrb();
        }
    }, 2000 + Math.random() * 2000); // 2-4 —Å–µ–∫—É–Ω–¥—ã
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±–æ—Ä–∞
function updateAvailableSkills(choice) {
    if (choice.skills && choice.skills.length > 0) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–≤—ã–∫–∏ –∏–∑ –≤—ã–±–æ—Ä–∞ (—ç—Ç–æ –Ω–∞–≤—ã–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)
        availableSkills = choice.skills.map(skill => ({
            name: skill.name,
            displayName: skill.displayName,
            sessionField: skill.sessionField, 
            icon: skill.icon || getSkillIcon(skill.sessionField),
            color: skill.color,
            type: skill.sessionField  // –î–æ–±–∞–≤–ª—è–µ–º type –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        }));
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –∏–∑ –≤—ã–±–æ—Ä–∞:', availableSkills);
    } else {
        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –Ω–∞–≤—ã–∫–∏ –∏–∑ API, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (window.apiSkills && window.apiSkills.length > 0) {
            availableSkills = [...window.apiSkills];
            console.log('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—Å–µ –Ω–∞–≤—ã–∫–∏ –∏–∑ API (fallback)');
        } else {
            // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback: —Å—Ç–∞—Ä—ã–µ –Ω–∞–≤—ã–∫–∏
            availableSkills = [...skillTypes];
            console.log('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –Ω–∞–≤—ã–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–π fallback)');
        }
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–∞–≤—ã–∫–∞ (fallback)
function getSkillIcon(skillName) {
    const iconMap = {
        'prototype': '‚öôÔ∏è',
        'presentation': 'üìä',
        'pitching': 'üéØ',
        'team': 'üë•'
    };
    return iconMap[skillName] || '‚≠ê';
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä—É–∂–æ—á–∫–∞ –Ω–∞–≤—ã–∫–∞
function createSkillOrb() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–∞–≤—ã–∫–∏ –≤–æ–æ–±—â–µ
    if (availableSkills.length === 0 && skillTypes.length === 0) {
        console.log('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–±–æ–≤');
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –∏–∑ API –∏–ª–∏ fallback
    const skillsToUse = availableSkills.length > 0 ? availableSkills : skillTypes;
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–≤—ã–∫ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
    const skillData = skillsToUse[Math.floor(Math.random() * skillsToUse.length)];
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞–≤—ã–∫–∞ –≤ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    const skillType = {
        type: skillData.sessionField || skillData.type,  // –î–ª—è API –∏—Å–ø–æ–ª—å–∑—É–µ–º sessionField, –¥–ª—è fallback - type
        name: skillData.displayName || skillData.name,
        icon: skillData.icon,
        color: skillData.color
    };
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫—Ä—É–∂–æ—á–∫–∞
    const orb = document.createElement('div');
    orb.className = `skill-orb ${skillType.type}`;
    orb.textContent = skillType.icon;
    orb.setAttribute('data-skill', skillType.type);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ü–≤–µ—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (skillType.color) {
        orb.style.background = `linear-gradient(135deg, ${skillType.color} 0%, ${skillType.color}aa 100%)`;
        orb.style.boxShadow = `0 4px 20px ${skillType.color}66`;
    }
    
    // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (—É—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫—Ä—É–∂–æ—á–∫–∞)
    const leftPosition = Math.random() * (window.innerWidth - 120);
    orb.style.left = leftPosition + 'px';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    orb.addEventListener('click', function(event) {
        handleSkillOrbClick(orb, skillType, event);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
    document.body.appendChild(orb);
    activeOrbs.push(orb);
    
    // –£–¥–∞–ª—è–µ–º –∫—Ä—É–∂–æ—á–µ–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏
    setTimeout(() => {
        if (orb.parentNode) {
            orb.remove();
            const index = activeOrbs.indexOf(orb);
            if (index !== -1) {
                activeOrbs.splice(index, 1);
            }
        }
    }, 5000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫—Ä—É–∂–æ—á–∫—É
function handleSkillOrbClick(orb, skillType, event) {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏
    orb.style.pointerEvents = 'none';
    orb.classList.add('clicked');
    
    // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –º—ã—à—å—é
    const clickX = event.clientX; // X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∫–ª–∏–∫–∞
    const clickY = event.clientY; // Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∫–ª–∏–∫–∞
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫—Ä—É–∂–æ—á–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const orbRect = orb.getBoundingClientRect();
    const halfWidth = orbRect.width / 2;
    const halfHeight = orbRect.height / 2;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–¥—ä–µ–º–∞ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –í –¢–û–ß–ö–ï –ö–õ–ò–ö–ê
    orb.style.animation = 'none';
    orb.style.position = 'fixed';
    orb.style.left = clickX - halfWidth + 'px';
    orb.style.top = clickY - halfHeight + 'px';
    orb.style.bottom = 'auto';
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
    orb.style.transform = 'scale(0.9)';
    setTimeout(() => {
        orb.style.transform = 'scale(1)';
    }, 100);
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞–≤—ã–∫
    currentSkills[skillType.type]++;
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–≤—ã–∫–∞ –≤ UI –ø–æ ID
    const skillValue = document.getElementById(`${skillType.type}-skill`);
    if (skillValue) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–∞
        skillValue.textContent = currentSkills[skillType.type];
        
        // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const skillElement = skillValue.closest('.skill-item-small');
        if (skillElement) {
            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏
            skillElement.classList.add('pulse');
            setTimeout(() => {
                skillElement.classList.remove('pulse');
            }, 600);
        }
        
        // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ–ª–µ—Ç –∫—Ä—É–∂–æ—á–∫–∞ –∫ –Ω–∞–≤—ã–∫—É (—Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∫–ª–∏–∫–∞)
        animateOrbToSkill(orb, skillElement, clickX, clickY);
    }
    
    // –£–¥–∞–ª—è–µ–º –∫—Ä—É–∂–æ—á–µ–∫ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    const index = activeOrbs.indexOf(orb);
    if (index !== -1) {
        activeOrbs.splice(index, 1);
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    syncSkillWithServer(skillType.type, currentSkills[skillType.type]);
}

// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–µ—Ç–∞ –∫—Ä—É–∂–æ—á–∫–∞ –∫ –Ω–∞–≤—ã–∫—É
function animateOrbToSkill(orb, skillElement, clickX, clickY) {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–≤—ã–∫–∞ (–∫—É–¥–∞ –ª–µ—Ç–∏—Ç)
    const skillRect = skillElement.getBoundingClientRect(); 
    const endX = skillRect.left + skillRect.width/2;
    const endY = skillRect.top + skillRect.height/2;
    
    // –ö—Ä—É–∂–æ—á–µ–∫ —É–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞ –≤ handleSkillOrbClick
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–ª–µ—Ç–∞
    orb.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    // –ß–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–µ—Ç –æ—Ç —Ç–æ—á–∫–∏ –∫–ª–∏–∫–∞ –∫ –Ω–∞–≤—ã–∫—É
    setTimeout(() => {
        const orbRect = orb.getBoundingClientRect();
        const halfWidth = orbRect.width / 2;
        const halfHeight = orbRect.height / 2;
        
        orb.style.left = endX - halfWidth + 'px';
        orb.style.top = endY - halfHeight + 'px';
        orb.style.transform = 'scale(0.3)';
        orb.style.opacity = '0.7';
    }, 150);
    
    // –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏
    setTimeout(() => {
        orb.style.opacity = '0';
        orb.style.transform = 'scale(0.1)';
    }, 600);
    
    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        if (orb.parentNode) {
            orb.remove();
        }
    }, 700);
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞–≤—ã–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function syncSkillWithServer(skillType, value) {
    if (typeof fetch !== 'undefined') {
        fetch('/game/api/skill/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                skill_type: skillType,
                value: value
            })
        }).catch(err => console.log('Skill sync error:', err));
    }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∫—Ä—É–∂–æ—á–∫–æ–≤ (–¥–ª—è –ø–∞—É–∑—ã –∏–≥—Ä—ã)
function stopSkillOrbSystem() {
    if (skillOrbInterval) {
        clearInterval(skillOrbInterval);
        skillOrbInterval = null;
    }
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä—É–∂–æ—á–∫–∏
    activeOrbs.forEach(orb => {
        if (orb.parentNode) {
            orb.remove();
        }
    });
    activeOrbs = [];
}

// –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—Ä—É–∂–æ—á–∫–æ–≤
function resumeSkillOrbSystem() {
    if (!skillOrbInterval) {
        startSkillOrbSystem();
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ UI –Ω–∞–≤—ã–∫–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
function createSkillsUI() {
    const skillsContainer = document.getElementById('skillsContainer');
    const loadingElement = document.getElementById('skillsLoading');
    
    if (!skillsContainer) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–≤—ã–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    if (loadingElement) {
        loadingElement.remove();
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–≤—ã–∫–∏ –∏–∑ API –∏–ª–∏ fallback
    const skillsToRender = window.availableSkills && window.availableSkills.length > 0 ? window.availableSkills : skillTypes;
    
    if (skillsToRender.length === 0) {
        skillsContainer.innerHTML = '<div class="text-center text-muted">–ù–∞–≤—ã–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
        return;
    }
    
    skillsContainer.innerHTML = '';
    
    skillsToRender.forEach(skill => {
        const skillType = skill.sessionField || skill.type;
        const skillName = skill.displayName || skill.name;
        const skillIcon = skill.icon || getSkillIcon(skillType);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫ –≤ currentSkills –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (currentSkills[skillType] === undefined) {
            currentSkills[skillType] = 0;
        }
        
        const skillElement = document.createElement('div');
        skillElement.className = `skill-item-small ${skillType} mb-2`;
        skillElement.innerHTML = `
            <div class="skill-icon-small">
                ${skillIcon}
            </div>
            <div class="skill-info-small">
                <div class="skill-value-small" id="${skillType}-skill">${currentSkills[skillType]}</div>
                <div class="skill-label-small">${skillName}</div>
            </div>
        `;
        
        skillsContainer.appendChild(skillElement);
    });
    
    console.log('UI –Ω–∞–≤—ã–∫–æ–≤ —Å–æ–∑–¥–∞–Ω –¥–ª—è:', skillsToRender.length, '–Ω–∞–≤—ã–∫–æ–≤');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞–≤—ã–∫–æ–≤
function updateSkillsUI() {
    Object.keys(currentSkills).forEach(skillType => {
        // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ ID (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
        const skillValue = document.getElementById(`${skillType}-skill`);
        if (skillValue) {
            skillValue.textContent = currentSkills[skillType];
            
            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            const skillElement = skillValue.closest('.skill-item-small');
            if (skillElement) {
                // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏
                skillElement.classList.add('pulse');
                setTimeout(() => {
                    skillElement.classList.remove('pulse');
                }, 600);
            }
        }
    });
}

// API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
async function loadCompletedEvents() {
    try {
        const response = await fetch('/game/api/completed-events/');
        if (response.ok) {
            const data = await response.json();
            window.completedEvents = data.completed_events || [];
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', window.completedEvents.length);
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', response.status);
            window.completedEvents = [];
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', error);
        window.completedEvents = [];
    }
}

async function markEventAsCompleted(eventKey, choiceId = '') {
    try {
        const response = await fetch('/game/api/complete-event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                event_key: eventKey,
                choice_id: choiceId
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('–°–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ:', eventKey);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
            if (!window.completedEvents) {
                window.completedEvents = [];
            }
            window.completedEvents.push({
                event_key: eventKey,
                choice_id: choiceId
            });
            
            return data;
        } else {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', response.status);
            return null;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:', error);
        return null;
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
}
</script>