{% extends 'base.html' %}
{% load static %}

{% block title %}Startup Game{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'startup_game/css/game.css' %}">
<style>
.game-stage {
    display: none;
}
.game-stage.active {
    display: block;
}
.stage-indicator {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 20px;
}
.stage-step {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    line-height: 30px;
    text-align: center;
    margin: 0 10px;
    color: white;
}
.stage-step.active {
    background: #007bff;
}
.stage-step.completed {
    background: #28a745;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'startup_game/js/game.js' %}"></script>

{% if session %}
{{ session|json_script:"game-session-data" }}
<script type="text/javascript">
// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã –∏–∑ Django –≤ JavaScript
const sessionData = JSON.parse(document.getElementById('game-session-data').textContent);
window.gameTimerData = {};
window.gameTimerData.gameTime = parseInt(sessionData.game_time || 480);
window.gameTimerData.gameDay = parseInt(sessionData.day || 1);
window.gameTimerData.currentMoney = parseInt(sessionData.money || 500);
window.gameTimerData.gamePaused = sessionData.game_paused || false;

document.addEventListener('DOMContentLoaded', function() {
    window.gameData = {
        money: parseInt(sessionData.money || 500),
        reputation: parseInt(sessionData.reputation || 0),
        employees: parseInt(sessionData.employees || 1),
        customers: parseInt(sessionData.customers || 0),
        day: parseInt(sessionData.day || 1),
        level: parseInt(sessionData.level || 1)
    };
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω —Å—Ä–∞–∑—É
    showGameStage('gameplay');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    if (typeof updateGameData === 'function') {
        updateGameData(window.gameData);
    }
});
</script>
{% else %}
<script type="text/javascript">
// –õ–æ–≥–∏–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
let currentStage = 1;
let companyData = {};

document.addEventListener('DOMContentLoaded', function() {
    showGameStage('company-name');
});

function showGameStage(stageId) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã
    document.querySelectorAll('.game-stage').forEach(stage => {
        stage.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç—Ç–∞–ø
    const targetStage = document.getElementById(stageId);
    if (targetStage) {
        targetStage.classList.add('active');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ç–∞–ø–æ–≤
    updateStageIndicator(stageId);
}

function updateStageIndicator(stageId) {
    const steps = document.querySelectorAll('.stage-step');
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        
        if (stageId === 'company-name' && index === 0) {
            step.classList.add('active');
        } else if (stageId === 'industry-select' && index === 1) {
            step.classList.add('active');
            if (index === 0) step.classList.add('completed');
        } else if (stageId === 'gameplay' && index === 2) {
            step.classList.add('active');
            if (index < 2) step.classList.add('completed');
        } else if (
            (stageId === 'industry-select' && index === 0) ||
            (stageId === 'gameplay' && index < 2)
        ) {
            step.classList.add('completed');
        }
    });
}

function nextStage(fromStage) {
    if (fromStage === 'company-name') {
        const companyName = document.getElementById('company_name').value.trim();
        if (!companyName) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏');
            return;
        }
        companyData.company_name = companyName;
        showGameStage('industry-select');
    } else if (fromStage === 'industry-select') {
        const industry = document.querySelector('input[name="industry"]:checked');
        if (!industry) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ä–∞—Å–ª—å');
            return;
        }
        companyData.industry = industry.value;
        createCompany();
    }
}

function createCompany() {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('{% url "startup_game:game" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams(companyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–≥—Ä—ã
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏');
    });
}
</script>
{% endif %}
{% endblock %}

{% block content %}
<div class="game-screen-play">
    <div class="container-fluid py-4">
        
        {% if error_message %}
        <div class="alert alert-danger">
            <h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã</h4>
            <p>{{ error_message }}</p>
        </div>
        {% endif %}
        
        {% if not session %}
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ç–∞–ø–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ -->
        <div class="stage-indicator text-center">
            <div class="stage-step">1</div>
            <div class="stage-step">2</div>
            <div class="stage-step">3</div>
            <div class="mt-2">
                <small class="text-white">–ù–∞–∑–≤–∞–Ω–∏–µ ‚Üí –û—Ç—Ä–∞—Å–ª—å ‚Üí –ò–≥—Ä–∞</small>
            </div>
        </div>
        
        <!-- –≠—Ç–∞–ø 1: –í—ã–±–æ—Ä –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ -->
        <div id="company-name" class="game-stage">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card bg-dark text-white">
                        <div class="card-header text-center">
                            <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞</h3>
                            <p class="mb-0">–®–∞–≥ 1: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</p>
                        </div>
                        <div class="card-body">
                            {% csrf_token %}
                            <div class="form-group mb-3">
                                <label for="company_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏:</label>
                                <input type="text" class="form-control" id="company_name" 
                                       name="company_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." 
                                       value="{{ user.username }}'s Startup" maxlength="100" required>
                            </div>
                            <button type="button" class="btn btn-primary btn-lg w-100" 
                                    onclick="nextStage('company-name')">
                                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –≠—Ç–∞–ø 2: –í—ã–±–æ—Ä –æ—Ç—Ä–∞—Å–ª–∏ -->
        <div id="industry-select" class="game-stage">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card bg-dark text-white">
                        <div class="card-header text-center">
                            <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞</h3>
                            <p class="mb-0">–®–∞–≥ 2: –í—ã–±–æ—Ä –æ—Ç—Ä–∞—Å–ª–∏</p>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                                        <input type="radio" name="industry" value="IT" class="d-none">
                                        <i class="fas fa-laptop-code fa-3x mb-2"></i>
                                        <h5>IT</h5>
                                        <small>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</small>
                                    </label>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                                        <input type="radio" name="industry" value="FOOD" class="d-none">
                                        <i class="fas fa-utensils fa-3x mb-2"></i>
                                        <h5>–ï–¥–∞</h5>
                                        <small>–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∞</small>
                                    </label>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                                        <input type="radio" name="industry" value="RETAIL" class="d-none">
                                        <i class="fas fa-shopping-cart fa-3x mb-2"></i>
                                        <h5>–¢–æ—Ä–≥–æ–≤–ª—è</h5>
                                        <small>–†–æ–∑–Ω–∏—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è</small>
                                    </label>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                                        <input type="radio" name="industry" value="HEALTH" class="d-none">
                                        <i class="fas fa-heartbeat fa-3x mb-2"></i>
                                        <h5>–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h5>
                                        <small>–ú–µ–¥–∏—Ü–∏–Ω–∞ –∏ —Ñ–∏—Ç–Ω–µ—Å</small>
                                    </label>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                                        <input type="radio" name="industry" value="EDUCATION" class="d-none">
                                        <i class="fas fa-graduation-cap fa-3x mb-2"></i>
                                        <h5>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h5>
                                        <small>–û–±—É—á–µ–Ω–∏–µ –∏ –∫—É—Ä—Å—ã</small>
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success btn-lg w-100 mt-3" 
                                    onclick="nextStage('industry-select')">
                                –ù–∞—á–∞—Ç—å –∏–≥—Ä—É!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- –ò–≥—Ä–æ–≤–æ–π —Ç–∞–π–º–µ—Ä -->
        {% include 'startup_game/components/game_timer.html' %}
        
        <!-- –≠—Ç–∞–ø 3: –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å -->
        <div id="gameplay" class="game-stage active">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="game-header text-center">
                        <h1 class="display-4 mb-2">{{ session.company_name }}</h1>
                        <p class="lead">{{ session.get_industry_display }} ‚Ä¢ –î–µ–Ω—å {{ session.day }} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å {{ session.level }}</p>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="row">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="col-lg-3 mb-4">
                    <div class="game-stats-panel">
                        <h4 class="mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <div class="stat-label">–î–µ–Ω—å–≥–∏</div>
                                <div class="stat-value" id="money-display">${{ session.money }}</div>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon">‚≠ê</div>
                            <div class="stat-info">
                                <div class="stat-label">–†–µ–ø—É—Ç–∞—Ü–∏—è</div>
                                <div class="stat-value" id="reputation-display">{{ session.reputation }}</div>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
                                <div class="stat-value" id="employees-display">{{ session.employees }}</div>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon">üë§</div>
                            <div class="stat-info">
                                <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                                <div class="stat-value" id="customers-display">{{ session.customers }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                <div class="col-lg-6 mb-4">
                    <div class="game-main-panel">
                        <div class="current-situation">
                            <h4>–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è</h4>
                            <div class="situation-content">
                                <p class="mb-3">
                                    –í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è <strong>{{ session.company_name }}</strong> —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å—Ñ–µ—Ä–µ 
                                    <strong>{{ session.get_industry_display }}</strong>.
                                </p>
                                
                                {% if session.day == 1 %}
                                <div class="alert alert-info">
                                    <h5>üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h5>
                                    <p class="mb-0">
                                        –≠—Ç–æ –≤–∞—à –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è. 
                                        –£ –≤–∞—Å –µ—Å—Ç—å ${{ session.money }} —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞. 
                                        –ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ç—Ä–∞—Ç–∏—Ç—Å—è $50 –Ω–∞ —Ä–∞—Å—Ö–æ–¥—ã. 
                                        –í—Ä–µ–º—è –∏–¥–µ—Ç –±—ã—Å—Ç—Ä–æ - 1 –¥–µ–Ω—å = 30 —Å–µ–∫—É–Ω–¥!
                                    </p>
                                </div>
                                {% else %}
                                <div class="daily-summary">
                                    <p><strong>–î–æ—Ö–æ–¥—ã:</strong> ${{ daily_income }} ({{ session.customers }} –∫–ª–∏–µ–Ω—Ç–æ–≤ √ó $10)</p>
                                    <p><strong>–†–∞—Å—Ö–æ–¥—ã:</strong> ${{ daily_expenses }} ({{ session.employees }} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ √ó $50)</p>
                                    <p class="{% if daily_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        <strong>–ü—Ä–∏–±—ã–ª—å:</strong> ${{ daily_profit }}
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="col-lg-3 mb-4">
                    <div class="game-actions-panel">
                        <h4 class="mb-3">–î–µ–π—Å—Ç–≤–∏—è</h4>
                        
                        <button class="btn btn-outline-primary btn-block mb-2" onclick="gameAction('hire_employee')">
                            üë• –ù–∞–Ω—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ($100)
                        </button>
                        
                        <button class="btn btn-outline-success btn-block mb-2" onclick="gameAction('marketing')">
                            üì¢ –†–µ–∫–ª–∞–º–∞ ($50)
                        </button>
                        
                        <button class="btn btn-outline-info btn-block mb-2" onclick="gameAction('research')">
                            üî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ($75)
                        </button>
                        
                        <button class="btn btn-outline-warning btn-block mb-2" onclick="gameAction('upgrade')">
                            ‚ö° –£–ª—É—á—à–µ–Ω–∏—è ($200)
                        </button>
                        
                        <hr>
                        
                        <button class="btn btn-danger btn-block" onclick="confirmNewGame()">
                            üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –æ—Ç—Ä–∞—Å–ª–µ–π */
input[name="industry"]:checked + .btn-outline-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
{% endblock %}